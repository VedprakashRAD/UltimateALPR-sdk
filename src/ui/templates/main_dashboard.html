<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vehicle Tracking System - Main Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
    <style>
        .dashboard-card {
            border-radius: 15px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
            margin-bottom: 20px;
        }
        .dashboard-card:hover {
            transform: translateY(-5px);
        }
        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
        }
        .stat-label {
            font-size: 0.9rem;
            color: #6c757d;
        }
        .journey-item {
            border-left: 4px solid #0d6efd;
            padding-left: 15px;
            margin-bottom: 15px;
        }
        .employee-item {
            background-color: #f8f9fa;
            border-radius: 10px;
            padding: 10px;
            margin-bottom: 10px;
        }
        .navbar-brand {
            font-weight: bold;
            color: #fff !important;
        }
        .camera-feed {
            width: 100%;
            height: 300px;
            background-color: #000;
            border-radius: 10px;
            overflow: hidden;
        }
        .camera-placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #fff;
            font-size: 1.2rem;
        }
        .refresh-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 1000;
        }
        .simulate-btn {
            position: fixed;
            bottom: 30px;
            right: 100px;
            z-index: 1000;
        }
    </style>
</head>
<body class="bg-light">
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="bi bi-car-front-fill me-2"></i>Vehicle Tracking System
            </a>
            <div class="d-flex">
                <span class="navbar-text me-3">
                    <i class="bi bi-database me-1"></i> MongoDB
                </span>
                <span class="navbar-text">
                    <i class="bi bi-clock me-1"></i> <span id="current-time"></span>
                </span>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-12">
                <div class="alert alert-success alert-dismissible fade show" role="alert">
                    <i class="bi bi-info-circle me-2"></i>
                    <strong>System Online!</strong> Access this dashboard at <a href="http://localhost:8080" class="alert-link">http://localhost:8080</a>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
                <h2 class="mb-4">
                    <i class="bi bi-speedometer2 me-2"></i>Main Dashboard
                </h2>
            </div>
        </div>

        <!-- Camera Feeds -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card dashboard-card">
                    <div class="card-header bg-white">
                        <h5 class="mb-0">
                            <i class="bi bi-camera me-2"></i>Camera 1 - Front Plate (Entry Point)
                        </h5>
                        <small class="text-muted">Captures front number plate as vehicle enters</small>
                    </div>
                    <div class="card-body p-0">
                        <img src="/camera1_feed" class="img-fluid" alt="Camera 1 Feed" id="camera1-feed">
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card dashboard-card">
                    <div class="card-header bg-white">
                        <h5 class="mb-0">
                            <i class="bi bi-camera me-2"></i>Camera 2 - Rear Plate (Entry/Exit Point)
                        </h5>
                        <small class="text-muted">Captures rear plate during entry and exit</small>
                    </div>
                    <div class="card-body p-0">
                        <img src="/camera2_feed" class="img-fluid" alt="Camera 2 Feed" id="camera2-feed">
                    </div>
                </div>
            </div>
        </div>



        <!-- Vehicle Data Table -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card dashboard-card">
                    <div class="card-header bg-white">
                        <h5 class="mb-0">
                            <i class="bi bi-table me-2"></i>Vehicle Records
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Front Plate (Entry)</th>
                                        <th>Rear Plate (Entry)</th>
                                        <th>Entry Time</th>
                                        <th>Exit Time</th>
                                        <th>Employee Vehicle</th>
                                    </tr>
                                </thead>
                                <tbody id="vehicle-table-body">
                                    <tr>
                                        <td colspan="5" class="text-center py-3">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="visually-hidden">Loading...</span>
                                            </div>
                                            <p class="mt-2 mb-0">Loading vehicle records...</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>



    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Update current time
        function updateTime() {
            const now = new Date();
            document.getElementById('current-time').textContent = now.toLocaleString();
        }
        updateTime();
        setInterval(updateTime, 1000);

        // Fetch data from API
        async function fetchData() {
            try {
                // Show loading state
                document.getElementById('vehicle-table-body').innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center py-3">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2 mb-0">Loading vehicle records...</p>
                        </td>
                    </tr>
                `;

                // Fetch stats
                const statsResponse = await fetch('/api/stats');
                const statsData = await statsResponse.json();
                
                if (statsData.success) {
                    // Update vehicle table
                    let tableHtml = '';
                    
                    // Process vehicle records with dual-camera entry/exit logic
                    const vehicleRecords = new Map();
                    
                    // Process entry events (Camera 1 captures front, Camera 2 captures rear)
                    if (statsData.recent_entry_events) {
                        statsData.recent_entry_events.forEach(event => {
                            const frontPlate = event.front_plate_number || 'Unknown';
                            const rearPlate = event.rear_plate_number || 'Unknown';
                            const vehicleKey = frontPlate + '_' + rearPlate;
                            
                            vehicleRecords.set(vehicleKey, {
                                front_plate: frontPlate,
                                rear_plate: rearPlate,
                                entry_time: event.entry_timestamp || event.entry_time,
                                exit_time: null,
                                is_employee: false,
                                vehicle_make: event.vehicle_make || 'Unknown',
                                vehicle_model: event.vehicle_model || 'Unknown',
                                vehicle_color: event.vehicle_color || 'Unknown'
                            });
                        });
                    }
                    
                    // Process exit events (Camera 2 captures rear first, then Camera 1 captures front)
                    if (statsData.recent_exit_events) {
                        statsData.recent_exit_events.forEach(event => {
                            const frontPlate = event.front_plate_number || 'Unknown';
                            const rearPlate = event.rear_plate_number || 'Unknown';
                            const vehicleKey = frontPlate + '_' + rearPlate;
                            
                            if (vehicleRecords.has(vehicleKey)) {
                                // Match with existing entry
                                vehicleRecords.get(vehicleKey).exit_time = event.exit_timestamp || event.exit_time;
                            } else {
                                // Exit without entry (anomaly)
                                vehicleRecords.set(vehicleKey, {
                                    front_plate: frontPlate,
                                    rear_plate: rearPlate,
                                    entry_time: null,
                                    exit_time: event.exit_timestamp || event.exit_time,
                                    is_employee: false,
                                    vehicle_make: event.vehicle_make || 'Unknown',
                                    vehicle_model: event.vehicle_model || 'Unknown',
                                    vehicle_color: event.vehicle_color || 'Unknown'
                                });
                            }
                        });
                    }
                    
                    // Check for employee vehicles
                    if (statsData.employee_vehicles) {
                        statsData.employee_vehicles.forEach(emp => {
                            vehicleRecords.forEach((record, key) => {
                                if (record.front_plate === emp.plate || record.rear_plate === emp.plate) {
                                    record.is_employee = true;
                                }
                            });
                        });
                    }
                    
                    // Generate table rows
                    if (vehicleRecords.size > 0) {
                        vehicleRecords.forEach((record, key) => {
                            const entryTime = record.entry_time ? new Date(record.entry_time).toLocaleString() : '-';
                            const exitTime = record.exit_time ? new Date(record.exit_time).toLocaleString() : '-';
                            const employeeBadge = record.is_employee ? '<span class="badge bg-success">Yes</span>' : '<span class="badge bg-secondary">No</span>';
                            
                            // Add anomaly detection
                            let statusBadge = '';
                            if (!record.entry_time && record.exit_time) {
                                statusBadge = '<span class="badge bg-warning ms-1">Exit Only</span>';
                            } else if (record.entry_time && !record.exit_time) {
                                statusBadge = '<span class="badge bg-info ms-1">In Progress</span>';
                            }
                            
                            tableHtml += `
                                <tr>
                                    <td>${record.front_plate} ${statusBadge}</td>
                                    <td>${record.rear_plate}</td>
                                    <td>${entryTime}</td>
                                    <td>${exitTime}</td>
                                    <td>${employeeBadge}</td>
                                </tr>
                            `;
                        });
                    } else {
                        tableHtml = '<tr><td colspan="5" class="text-center py-3">No vehicle records found</td></tr>';
                    }
                    
                    document.getElementById('vehicle-table-body').innerHTML = tableHtml;
                }


            } catch (error) {
                console.error('Error fetching data:', error);
                document.getElementById('vehicle-table-body').innerHTML = '<tr><td colspan="5" class="text-center py-3 text-danger">Error loading data</td></tr>';
            }
        }

        // Simulate vehicle
        async function simulateVehicle() {
            try {
                const response = await fetch('/api/simulate_vehicle');
                const data = await response.json();
                
                if (data.success) {
                    // Show success message
                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'alert alert-success alert-dismissible fade show position-fixed';
                    alertDiv.style.bottom = '20px';
                    alertDiv.style.right = '20px';
                    alertDiv.style.zIndex = '9999';
                    alertDiv.innerHTML = `
                        <i class="bi bi-check-circle me-2"></i>
                        <strong>Success!</strong> Vehicle ${data.plate} processed
                        ${data.is_employee ? '<span class="badge bg-success ms-2">Employee</span>' : ''}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    `;
                    document.body.appendChild(alertDiv);
                    
                    // Auto remove after 3 seconds
                    setTimeout(() => {
                        if (alertDiv.parentNode) {
                            alertDiv.parentNode.removeChild(alertDiv);
                        }
                    }, 3000);
                    
                    // Refresh data
                    fetchData();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                console.error('Error simulating vehicle:', error);
                alert('Error simulating vehicle');
            }
        }

        // Initial data load
        document.addEventListener('DOMContentLoaded', function() {
            fetchData();
        });



        // Auto-refresh every 1 second for real-time updates
        setInterval(fetchData, 1000);
        
        // Refresh camera feeds every 30 seconds to prevent caching
        setInterval(function() {
            const timestamp = new Date().getTime();
            document.getElementById('camera1-feed').src = '/camera1_feed?' + timestamp;
            document.getElementById('camera2-feed').src = '/camera2_feed?' + timestamp;
        }, 30000);
    </script>
    
    <style>
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .spin {
            animation: spin 1s linear infinite;
        }
    </style>
</body>
</html>